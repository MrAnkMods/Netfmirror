<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NMix ‚Äî Details</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body {
    margin:0;
    background:#000;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    line-height:1.4;
  }
  .wrap{padding-bottom:60px;}

  .topbar{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    background:#000;
    border-bottom:1px solid #111;
    padding:10px 16px;
    position:sticky;
    top:0;
    z-index:100;
  }
  .backBtn{
    font-size:20px;
    font-weight:bold;
    color:#fff;
    background:none;
    border:none;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .backBtn:hover{opacity:0.7;}
  .backBtn span{font-size:15px;color:#ccc;}

  .banner{
    position:relative;
    width:100%;
    height:230px;
    overflow:hidden;
  }
  .banner img{
    width:100%;
    height:100%;
    object-fit:cover;
    filter:brightness(0.65);
  }
  .overlay{
    position:absolute;
    bottom:20px;
    left:20px;
    right:20px;
  }
  .title{font-size:24px;font-weight:bold;margin-bottom:4px;}
  .meta{font-size:14px;color:#ccc;margin-bottom:14px;}

  /* Netflix style stacked buttons */
  .btns{
    display:flex;
    flex-direction:column;
    gap:10px;
    width:100%;
    max-width:90%;
  }
  .btn{
    border:none;
    border-radius:4px;
    font-weight:bold;
    font-size:16px;
    cursor:pointer;
    padding:12px 0;
    width:100%;
  }
  .btn.play{
    background:#fff;
    color:#000;
  }
  .btn.download{
    background:#333;
    color:#fff;
    border:1px solid #555;
  }
  .btn.play:hover{background:#e5e5e5;}
  .btn.download:hover{background:#444;}

  .desc{padding:16px 20px;color:#bbb;font-size:15px;}

  .episodes{padding:10px 20px;}
  .episodes h3{margin:10px 0;font-size:18px;}
  .ep{
    display:flex;align-items:center;justify-content:space-between;
    background:#111;border-radius:8px;padding:10px;margin-bottom:8px;
  }
  .ep .left{display:flex;align-items:center;gap:10px;}
  .ep img{width:100px;height:60px;object-fit:cover;border-radius:6px;}
  .ep .info{font-size:14px;}
  .ep button{border:none;background:transparent;color:#fff;font-size:18px;cursor:pointer;}

  .suggested{padding:10px 20px;}
  .suggested h3{font-size:18px;margin:10px 0;}
  .suggestRow{display:flex;gap:10px;overflow:auto;padding-bottom:10px;}
  .sCard{min-width:130px;background:#111;border-radius:8px;overflow:hidden;cursor:pointer;}
  .sCard img{width:130px;height:180px;object-fit:cover;}

  #toast {
    visibility: hidden;
    min-width: 220px;
    background-color: #e50914;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 10px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-weight: bold;
  }
  #toast.show {
    visibility: visible;
    animation: fadein 0.4s, fadeout 0.4s 2.5s;
  }
  @keyframes fadein {from {bottom: 0; opacity: 0;}to {bottom: 30px; opacity: 1;}}
  @keyframes fadeout {from {bottom: 30px; opacity: 1;}to {bottom: 0; opacity: 0;}}
</style>
</head>
<body>

<div class="topbar">
  <button class="backBtn" id="backBtn">‚Üê <span>Back</span></button>
</div>

<div class="wrap" id="mainArea"></div>
<div id="toast">Not available right now</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4S_DbJCwOyg2akeBmInBYcuBrPvvVrj8",
  authDomain: "ankmods0.firebaseapp.com",
  databaseURL: "https://ankmods0-default-rtdb.firebaseio.com",
  projectId: "ankmods0",
  storageBucket: "ankmods0.firebasestorage.app",
  messagingSenderId: "760044029682",
  appId: "1:760044029682:web:a5c234e03542c309ce726b"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(location.search);
const type = params.get("type") || "movie";
const id = params.get("id");
const main = document.getElementById("mainArea");
const backBtn = document.getElementById("backBtn");
backBtn.onclick = ()=> history.back();

function showToast(msg){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

if(!id){ 
  main.innerHTML = "<p style='padding:20px'>No item specified.</p>"; 
} else {
  const node = type === "series" ? "series" : "movies";
  onValue(ref(db, node + "/" + id), snap=>{
    const d = snap.val();
    if(!d){ 
      main.innerHTML = "<p style='padding:20px'>Item not found.</p>"; 
      return; 
    }

    // ‚úÖ Description fallback fix
    const descText = d.description || d.decreption || d.deception || d.desc || "No description available.";

    let html = `
      <div class="banner">
        <img src="${d.poster || 'assets/banner1.jpg'}">
        <div class="overlay">
          <div class="title">${d.title || ''}</div>
          <div class="meta">${d.year || ''} ‚Ä¢ ${d.category || d.section || ''}</div>
          <div class="btns">
            <button class="btn play" id="playBtn">‚ñ∂ Play</button>
            <button class="btn download" id="downloadBtn">‚¨á Download</button>
          </div>
        </div>
      </div>
      <div class="desc">${descText}</div>
    `;

    if(type === "series" && d.seasons?.length){
      html += `<div class="episodes"><h3>Episodes</h3>`;
      d.seasons.forEach((s)=>{
        s.episodes?.forEach((ep, ei)=>{
          html += `
            <div class="ep">
              <div class="left">
                <img src="${ep.thumb || d.poster || 'assets/banner1.jpg'}">
                <div class="info"><b>${ep.epTitle || ('Episode '+(ei+1))}</b><br>${ep.duration || ''}</div>
              </div>
              <button class="epPlay" data-video="${encodeURIComponent(ep.video || '')}">‚ñ∂</button>
            </div>`;
        });
      });
      html += `</div>`;
    }

    html += `<div class="suggested"><h3>${type === 'series' ? 'Similar Series' : 'More Like This'}</h3><div class="suggestRow" id="suggestRow"></div></div>`;
    main.innerHTML = html;

    // ‚úÖ Play Button Fix (fetches correct video)
    const playBtn = document.getElementById("playBtn");
    playBtn.onclick = ()=>{
      let videoUrl = d.video || d.videourl || d.link || "";
      let titleTxt = d.title || "";
      
      if(type === "series" && (!videoUrl) && d.seasons?.length){
        const firstEp = d.seasons[0].episodes?.[0];
        if(firstEp?.video || firstEp?.link) videoUrl = firstEp.video || firstEp.link;
      }

      if(!videoUrl){
        showToast("No video available");
        console.warn("No video URL found in Firebase for item:", id);
        return;
      }

      localStorage.setItem("lastId", id);
      localStorage.setItem("lastType", type);
      localStorage.setItem("lastPage", "details");

      const url = `player.html?src=${encodeURIComponent(videoUrl)}&title=${encodeURIComponent(titleTxt)}&from=details`;
      window.location = url;
    };

    // üîΩ Download button (works if video link present)
    document.getElementById("downloadBtn").onclick = ()=>{
      let link = d.video || d.videourl || d.link || "";
      if(!link){
        showToast("Download not available");
        return;
      }
      window.open(link, "_blank");
    };

    // ‚ñ∂ Each Episode play button
    document.querySelectorAll(".epPlay").forEach(b=>{
      b.onclick = (ev)=>{
        let v = decodeURIComponent(ev.currentTarget.dataset.video||'');
        if(!v){ showToast("No video found"); return; }

        localStorage.setItem("lastId", id);
        localStorage.setItem("lastType", type);
        localStorage.setItem("lastPage", "details");

        const playerUrl = `player.html?src=${encodeURIComponent(v)}&title=${encodeURIComponent(d.title || '')}&from=details`;
        window.location = playerUrl;
      };
    });

    loadSuggestions(node, d.category || d.section || '', id);
  });
}

function loadSuggestions(node, category, currentId){
  const suggestRow = document.getElementById("suggestRow");
  if(!suggestRow) return;
  onValue(ref(db, node), snap=>{
    suggestRow.innerHTML = "";
    snap.forEach(s=>{
      const id = s.key;
      const d = s.val();
      if(id === currentId) return;
      const cat = (d.category || d.section || "").toLowerCase();
      if(cat.includes(category.toLowerCase())){
        const card = document.createElement("div");
        card.className = "sCard";
        const img = document.createElement("img");
        img.src = d.poster || "";
        img.onclick = ()=> window.location = `details.html?type=${node}&id=${id}`;
        card.appendChild(img);
        suggestRow.appendChild(card);
      }
    });
  });
}
</script>
</body>
</html>