<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NMix — Details</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<style>
/* ---------- Base ---------- */
body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;line-height:1.4;}
.wrap{padding-bottom:60px;}
.topbar{display:flex;align-items:center;background:#000;border-bottom:1px solid #111;padding:10px 12px;position:sticky;top:0;z-index:100;}
.backBtn{font-size:20px;font-weight:bold;color:#fff;background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;}
.backBtn span{font-size:15px;color:#ccc;}
.backBtn:hover{opacity:0.7;}
.banner{
  width:100%;
  height:260px;
  background:#000;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  border-bottom:1px solid #111;
}
.banner img{
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center 20%;
  filter:brightness(0.9);
  display:block;
  background:#000;
}
.infoBox{text-align:center;padding:12px 10px 0 10px;}
.title{font-size:23px;font-weight:bold;margin-bottom:4px;}
.meta{font-size:14px;color:#ccc;margin-bottom:14px;}
.btns{display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;padding:0 10px;}
.btn{border:none;border-radius:4px;font-weight:bold;font-size:16px;cursor:pointer;padding:12px 0;width:90%;max-width:380px;}
.btn.play{background:#fff;color:#000;}
.btn.download{background:#333;color:#fff;border:1px solid #555;}
.btn.play:hover{background:#e5e5e5;}
.btn.download:hover{background:#444;}
.desc{color:#bbb;font-size:15px;padding:12px 14px;text-align:left;}

/* ---------- Episodes & Season selector ---------- */
.episodes{padding:0;margin-top:10px;}
.episodes h3{font-size:18px;padding:10px 14px;margin:0;display:flex;align-items:center;justify-content:space-between;}
.seasonBtn{
  background:rgba(20,20,20,0.85);
  color:#fff;
  border:1px solid #333;
  border-radius:8px;
  padding:6px 12px;
  font-size:14px;
  cursor:pointer;
  font-weight:bold;
  backdrop-filter:blur(8px);
  box-shadow:0 0 8px rgba(255,255,255,0.1);
}
.seasonBtn:hover{border-color:#e50914;color:#e50914;}

/* ---------- Custom Season Popup ---------- */
#seasonPopup{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:999;
  backdrop-filter:blur(6px);
  animation:fadeIn 0.28s ease;
}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.popupBox{
  background:rgba(30,30,30,0.95);
  border-radius:12px;width:85%;max-width:340px;padding:14px;
  box-shadow:0 0 15px rgba(229,9,20,0.18);
}
.popupBox h4{ text-align:center;margin-bottom:10px;font-size:17px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:6px; }
.seasonItem{ padding:10px 12px;border-radius:8px;margin:6px 0;background:#111;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .18s, border .18s; }
.seasonItem:hover{background:#181818;}
.seasonItem.active{ border:1px solid #e50914;background:#1a1a1a; }
.seasonItem small{ color:#aaa; font-size:12px; margin-left:8px; }
.closePopup{ display:block;width:100%;background:#e50914;color:#fff;border:none;border-radius:6px;padding:10px 0;font-weight:bold;margin-top:10px;cursor:pointer; }

/* ---------- Episode Cards (animated) ---------- */
.ep{display:flex;align-items:center;justify-content:space-between;width:90%;margin:8px auto;background:#111;border-radius:8px;padding:10px 12px;border-bottom:0.4px solid rgba(255,255,255,0.07);transition:background .25s;}
.ep:hover{background:#181818;}
.ep .left{display:flex;align-items:center;gap:10px;flex:1;}
.ep img{width:100px;height:60px;object-fit:cover;border-radius:6px;}
.ep .info{font-size:14px;color:#ddd;flex:1;}
.ep .info b{color:#fff;}
.ep button{border:none;background:#222;color:#fff;font-size:18px;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.ep button:hover{background:#e50914;}

/* Animation: enter (fade + slide up) */
.ep.enter{
  opacity:0;
  transform:translateY(12px);
}
.ep.enter.show{
  opacity:1;
  transform:translateY(0);
  transition:opacity .36s cubic-bezier(.2,.9,.2,1), transform .36s cubic-bezier(.2,.9,.2,1);
}

/* ---------- Suggestions ---------- */
.suggested{margin-top:15px;padding:0;}
.suggested h3{font-size:18px;margin:10px 14px;}
.suggestRow{display:flex;overflow-x:auto;gap:10px;padding:10px 14px 20px 14px;scroll-snap-type:x mandatory;}
.suggestRow::-webkit-scrollbar{display:none;}
.sCard{flex:0 0 auto;width:130px;border-radius:10px;overflow:hidden;scroll-snap-align:start;transition:transform .3s ease,filter .3s ease;cursor:pointer;}
.sCard img{width:100%;height:190px;object-fit:cover;border-radius:10px;}
.sCard:hover{transform:scale(1.05);filter:brightness(1.1);}

/* ---------- Toast ---------- */
#toast{visibility:hidden;min-width:220px;background-color:#e50914;color:#fff;text-align:center;border-radius:6px;padding:10px;position:fixed;z-index:1000;left:50%;bottom:30px;transform:translateX(-50%);font-weight:bold;}
#toast.show{visibility:visible;animation:fadein .4s,fadeout .4s 2.5s;}
@keyframes fadein{from{bottom:0;opacity:0;}to{bottom:30px;opacity:1;}}
@keyframes fadeout{from{bottom:30px;opacity:1;}to{bottom:0;opacity:0;}}
</style>
</head>
<body>

<div class="topbar">
  <button class="backBtn" id="backBtn">← <span>Back</span></button>
</div>

<div class="wrap" id="mainArea"></div>

<!-- Custom Season Popup -->
<div id="seasonPopup">
  <div class="popupBox">
    <h4>Select Season</h4>
    <div id="seasonList"></div>
    <button class="closePopup" id="closePopup">Close</button>
  </div>
</div>

<div id="toast">Not available right now</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4S_DbJCwOyg2akeBmInBYcuBrPvvVrj8",
  authDomain: "ankmods0.firebaseapp.com",
  databaseURL: "https://ankmods0-default-rtdb.firebaseio.com",
  projectId: "ankmods0",
  storageBucket: "ankmods0.firebasestorage.app",
  messagingSenderId: "760044029682",
  appId: "1:760044029682:web:a5c234e03542c309ce726b"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const params = new URLSearchParams(location.search);
const type = params.get("type") || "movie";
const id = params.get("id");
const main = document.getElementById("mainArea");
const popup = document.getElementById("seasonPopup");
const popupList = document.getElementById("seasonList");
const closePopup = document.getElementById("closePopup");
document.getElementById("backBtn").onclick = ()=>history.back();

function showToast(msg){
  const toast=document.getElementById("toast");
  toast.textContent=msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

/* ---------- Helper: animate entries with stagger ---------- */
function animateEntries(containerSelector, delay=60){
  const nodes = Array.from(document.querySelectorAll(containerSelector));
  nodes.forEach((n,i)=>{
    n.classList.add('enter');
    setTimeout(()=> n.classList.add('show'), 40 + i*delay);
    setTimeout(()=> n.classList.remove('enter','show'), 40 + i*delay + 420);
  });
}

/* ---------- Load item ---------- */
if(!id){main.innerHTML="<p style='padding:20px'>No item specified.</p>";}
else {
  const node = type==="series" ? "series" : "movies";
  onValue(ref(db, node + "/" + id), snap=>{
    const d = snap.val();
    if(!d){ main.innerHTML = "<p style='padding:20px'>Item not found.</p>"; return; }

    let descText = d.description || d.decreption || d.deception || d.desc || "";
    if(!descText && type === "series" && d.seasons?.length){
      descText = d.seasons[0].description || d.seasons[0].desc || "";
    }
    if(!descText) descText = "No description available.";

    let html = `
      <div class="banner"><img src="${d.poster || 'assets/banner1.jpg'}"></div>
      <div class="infoBox"><div class="title">${d.title || ''}</div><div class="meta">${d.year || ''} • ${d.category || d.section || ''}</div></div>
      <div class="btns"><button class="btn play" id="playBtn">▶ Play</button><button class="btn download" id="downloadBtn">⬇ Download</button></div>
      <div class="desc">${descText}</div>
    `;

    if(type === "series" && d.seasons?.length){
      html += `<div class="episodes"><h3>Episodes <button class="seasonBtn" id="openSeason">Season 1</button></h3><div id="epList"></div></div>`;
    }

    html += `<div class="suggested"><h3>${type==='series'?'Similar Series':'More Like This'}</h3><div class="suggestRow" id="suggestRow"></div></div>`;
    main.innerHTML = html;

    document.getElementById("playBtn").onclick = ()=>{
      let videoUrl = d.video || d.videourl || d.link || "";
      if(type === "series" && !videoUrl && d.seasons?.length){
        const firstEp = d.seasons[0].episodes?.[0];
        if(firstEp?.video) videoUrl = firstEp.video;
      }
      if(!videoUrl){ showToast("No video available"); return; }
      window.location = `player.html?src=${encodeURIComponent(videoUrl)}&title=${encodeURIComponent(d.title||'')}&from=details`;
    };
    document.getElementById("downloadBtn").onclick = ()=>showToast("Download Not Available");

    if(type === "series" && d.seasons?.length){
      const epList = document.getElementById("epList");
      const openBtn = document.getElementById("openSeason");
      let currentSeason = 0;

      function renderEpisodes(si){
        epList.innerHTML = "";
        const s = d.seasons[si];
        openBtn.textContent = s.name || `Season ${si+1}`;
        (s.episodes || []).forEach((ep, ei)=>{
          const epTitle = ep.epTitle || `Episode ${ei+1}`;
          const item = document.createElement("div");
          item.className = "ep";
          item.innerHTML = `
            <div class="left">
              <img src="${ep.thumb || d.poster || 'assets/banner1.jpg'}">
              <div class="info"><b>${epTitle}</b><br>${ep.duration || ''}</div>
            </div>
            <button class="epPlay" data-video="${encodeURIComponent(ep.video||'')}" data-eptitle="${epTitle}">▶</button>
          `;
          epList.appendChild(item);
        });
        animateEntries('#epList .ep', 80);
        attachEpEvents();
      }

      function attachEpEvents(){
        document.querySelectorAll(".epPlay").forEach(b=>{
          b.onclick = (ev)=>{
            let v = decodeURIComponent(ev.currentTarget.dataset.video||'');
            if(!v){ showToast("No video found"); return; }
            const epTitle = ev.currentTarget.dataset.eptitle || "Episode";
            const fullTitle = `${d.title || 'Series'} — ${epTitle}`;
            window.location = `player.html?src=${encodeURIComponent(v)}&title=${encodeURIComponent(fullTitle)}&from=details`;
          };
        });
      }

      openBtn.onclick = ()=>{
        popup.style.display = "flex";
        popupList.innerHTML = "";
        d.seasons.forEach((s, i)=>{
          const epCount = (s.episodes || []).length || 0;
          const div = document.createElement("div");
          div.className = "seasonItem" + (i===currentSeason ? " active" : "");
          div.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><span>${s.name || `Season ${i+1}`}</span><small style="color:#aaa">${epCount} Episodes</small></div>`;
          div.onclick = ()=>{
            currentSeason = i;
            renderEpisodes(i);
            popup.style.display = "none";
          };
          popupList.appendChild(div);
        });
      };

      closePopup.onclick = ()=> popup.style.display = "none";
      renderEpisodes(0);
    }
    loadSuggestions(node, d.category || d.section || '', id);
  });
}

function loadSuggestions(node, category, currentId){
  const suggestRow = document.getElementById("suggestRow");
  if(!suggestRow) return;
  onValue(ref(db, node), snap=>{
    suggestRow.innerHTML = "";
    snap.forEach(s=>{
      const sid = s.key; const d = s.val();
      if(sid === currentId) return;
      const cat = (d.category || d.section || "").toLowerCase();
      if(cat.includes(category.toLowerCase())){
        const card = document.createElement("div");
        card.className = "sCard";
        const img = document.createElement("img");
        img.src = d.poster || "";
        img.onclick = ()=> window.location = `details.html?type=${node}&id=${sid}`;
        card.appendChild(img);
        suggestRow.appendChild(card);
      }
    });
  });
}
</script>
</body>
</html>
