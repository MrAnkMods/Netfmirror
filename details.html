<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NMix ‚Äî Details</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{margin:0;background:#000;color:#fff;font-family:Inter,Arial;line-height:1.4}
  .wrap{padding:12px}
  .back{display:inline-block;padding:8px 10px;background:#111;border-radius:8px;cursor:pointer;margin-bottom:12px}
  .hero{display:flex;gap:14px;align-items:flex-start}
  .poster{width:150px;height:220px;object-fit:cover;border-radius:8px;border:2px solid rgba(255,255,255,.06)}
  h1{margin:2px 0 8px 0;font-size:22px}
  .meta{color:#9a9a9a;margin-bottom:12px}
  .btn{padding:10px 16px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn.primary{background:#fff;color:#000;margin-right:10px}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.12);color:#fff}
  .episodes{margin-top:18px}
  .season{margin-top:10px;border-top:1px solid #111;padding-top:10px}
  .ep{background:#111;padding:10px;border-radius:8px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
  .related{margin-top:18px}
  .row{display:flex;gap:12px;overflow:auto;padding-bottom:6px}
  .card{min-width:120px}
  .card img{width:120px;height:160px;object-fit:cover;border-radius:8px}
  
  /* üî• Simple toast style */
  #toast {
    visibility: hidden;
    min-width: 220px;
    background-color: #e50914;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 10px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-weight: bold;
  }
  #toast.show {
    visibility: visible;
    animation: fadein 0.4s, fadeout 0.4s 2.5s;
  }
  @keyframes fadein {
    from {bottom: 0; opacity: 0;}
    to {bottom: 30px; opacity: 1;}
  }
  @keyframes fadeout {
    from {bottom: 30px; opacity: 1;}
    to {bottom: 0; opacity: 0;}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="back" id="backBtn">‚Üê Back</div>
  <div id="mainArea"></div>
</div>

<!-- üî• Toast element -->
<div id="toast">Not available right now</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4S_DbJCwOyg2akeBmInBYcuBrPvvVrj8",
  authDomain: "ankmods0.firebaseapp.com",
  databaseURL: "https://ankmods0-default-rtdb.firebaseio.com",
  projectId: "ankmods0",
  storageBucket: "ankmods0.firebasestorage.app",
  messagingSenderId: "760044029682",
  appId: "1:760044029682:web:a5c234e03542c309ce726b"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(location.search);
const type = params.get("type") || "movie";
const id = params.get("id");

const main = document.getElementById("mainArea");
const backBtn = document.getElementById("backBtn");
backBtn.onclick = ()=>{
  if (document.referrer) return window.history.back();
  location.href = "index.html";
};

function showToast(msg){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

if(!id){ main.innerHTML = "<p>No item specified.</p>"; }
else {
  const node = type === "series" ? "series" : "movies";
  onValue(ref(db, node + "/" + id), snap=>{
    const d = snap.val();
    if(!d){ main.innerHTML = "<p>Item not found.</p>"; return; }

    let html = `
      <div class="hero">
        <img class="poster" src="${d.poster||'assets/banner1.jpg'}" />
        <div style="flex:1">
          <h1>${d.title||''}</h1>
          <div class="meta">${d.category || d.section || ''} ‚Ä¢ ${d.year||''}</div>
          <div>
            <button class="btn primary" id="playBtn">‚ñ∂ Play</button>
            <button class="btn secondary" id="downloadBtn">‚¨á Download</button>
          </div>
          <p style="margin-top:12px;color:#bbb">${d.description || ''}</p>
        </div>
      </div>
    `;

    if(type === "series"){
      html += `<div class="episodes"><h3>Seasons & Episodes</h3>`;
      (d.seasons || []).forEach((s, idx)=>{
        html += `<div class="season"><strong>${s.season || 'Season '+(idx+1)}</strong>`;
        s.episodes.forEach((ep, eidx)=>{
          html += `<div class="ep"><div>${ep.epTitle||('Episode '+(eidx+1))}</div>
                   <div><button class="btn primary epPlay" data-video="${encodeURIComponent(ep.video||'')}">Play</button></div></div>`;
        });
        html += `</div>`;
      });
      html += `</div>`;
    }

    html += `<div class="related"><h3>More Like This</h3><div class="row" id="relatedRow"></div></div>`;
    main.innerHTML = html;

    const playBtn = document.getElementById("playBtn");

    // ‚ñ∂ Play Button
    playBtn.onclick = ()=>{
      let videoUrl = "";
      let titleTxt = d.title || "";
      if(type === "movie" && d.video){
        videoUrl = d.video;
      } else if(type === "series" && d.seasons?.length){
        const firstEp = d.seasons[0].episodes?.[0];
        if(firstEp?.video){
          videoUrl = firstEp.video;
          titleTxt += " ‚Äî " + (firstEp.epTitle || "Episode 1");
        }
      }
      if(!videoUrl){ alert("No video URL available"); return; }
      document.body.style.opacity = "0.7";
      document.body.style.pointerEvents = "none";
      setTimeout(()=>{
        const url = `player.html?src=${encodeURIComponent(videoUrl)}&title=${encodeURIComponent(titleTxt)}&poster=${encodeURIComponent(d.poster||'')}&prev=${encodeURIComponent(location.pathname+location.search)}`;
        window.location = url;
      },200);
    };

    // ‚¨á Download Button ‚Üí Show toast instead
    document.getElementById("downloadBtn").onclick = ()=>{
      showToast("Not available right now");
    };

    // Episode play buttons
    document.querySelectorAll(".epPlay").forEach(b=>{
      b.onclick = (ev)=>{
        let v = decodeURIComponent(ev.currentTarget.dataset.video||'');
        if(!v){ alert("No video URL"); return; }
        const titleEp = (d.title||'') + ' - ' + (ev.currentTarget.closest(".ep").querySelector("div").innerText || 'Episode');
        const playerUrl = `player.html?src=${encodeURIComponent(v)}&title=${encodeURIComponent(titleEp)}&poster=${encodeURIComponent(d.poster||'')}&prev=${encodeURIComponent(location.pathname+location.search)}`;
        window.location = playerUrl;
      };
    });

    // Related Section
    onValue(ref(db, "movies"), s2=>{
      const rel = document.getElementById("relatedRow");
      rel.innerHTML = "";
      s2.forEach(x=>{
        const val = x.val();
        if(val && val.category && d.category && val.category === d.category && x.key !== id){
          const card = document.createElement("div");
          card.className = "card";
          const img = document.createElement("img");
          img.src = val.poster;
          img.onclick = ()=> window.location = `details.html?type=movie&id=${x.key}`;
          card.appendChild(img);
          rel.appendChild(card);
        }
      });
    });
  });
}
</script>
</body>
</html>