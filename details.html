<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<title>NMix — Details</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{margin:0;background:#000;color:#fff;font-family:Inter,Arial;line-height:1.4}
  .wrap{padding:12px}
  .back{display:inline-block;padding:8px 10px;background:#111;border-radius:8px;cursor:pointer;margin-bottom:12px}
  .hero{display:flex;gap:14px;align-items:flex-start}
  .poster{width:150px;height:220px;object-fit:cover;border-radius:8px;border:2px solid rgba(255,255,255,.06)}
  h1{margin:2px 0 8px 0;font-size:22px}
  .meta{color:#9a9a9a;margin-bottom:12px}
  .btn{padding:10px 16px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn.primary{background:#fff;color:#000;margin-right:10px}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.12);color:#fff}
  .episodes{margin-top:18px}
  .season{margin-top:10px;border-top:1px solid #111;padding-top:10px}
  .ep{background:#111;padding:10px;border-radius:8px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
  .related{margin-top:18px}
  .row{display:flex;gap:12px;overflow:auto;padding-bottom:6px}
  .card{min-width:120px}
  .card img{width:120px;height:160px;object-fit:cover;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="back" id="backBtn">← Back</div>  <div id="mainArea"></div>
</div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4S_DbJCwOyg2akeBmInBYcuBrPvvVrj8",
  authDomain: "ankmods0.firebaseapp.com",
  databaseURL: "https://ankmods0-default-rtdb.firebaseio.com",
  projectId: "ankmods0",
  storageBucket: "ankmods0.firebasestorage.app",
  messagingSenderId: "760044029682",
  appId: "1:760044029682:web:a5c234e03542c309ce726b"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(location.search);
const type = params.get("type") || "movie";
const id = params.get("id");

const main = document.getElementById("mainArea");
const backBtn = document.getElementById("backBtn");
backBtn.onclick = ()=>{
  if (document.referrer) return window.history.back();
  location.href = "index.html";
};

if(!id){ main.innerHTML = "<p>No item specified.</p>"; }
else {
  const node = type === "series" ? "series" : "movies";
  onValue(ref(db, node + "/" + id), snap=>{
    const d = snap.val();
    if(!d){ main.innerHTML = "<p>Item not found.</p>"; return; }

    let html = `
      <div class="hero">
        <img class="poster" src="${d.poster||'assets/banner1.jpg'}" />
        <div style="flex:1">
          <h1>${d.title||''}</h1>
          <div class="meta">${d.category || d.section || ''} • ${d.year||''}</div>
          <div>
            <button class="btn primary" id="playBtn">▶ Play</button>
            <button class="btn secondary" id="downloadBtn">⬇ Download</button>
          </div>
          <p style="margin-top:12px;color:#bbb">${d.description || ''}</p>
        </div>
      </div>
    `;

    if(type === "series"){
      html += `<div class="episodes"><h3>Seasons & Episodes</h3>`;
      (d.seasons || []).forEach((s, idx)=>{
        html += `<div class="season"><strong>${s.season || 'Season '+(idx+1)}</strong>`;
        s.episodes.forEach((ep, eidx)=>{
          html += `<div class="ep"><div>${ep.epTitle||('Episode '+(eidx+1))}</div>
                   <div><button class="btn primary epPlay" data-video="${encodeURIComponent(ep.video||'')}">Play</button></div></div>`;
        });
        html += `</div>`;
      });
      html += `</div>`;
    }

    html += `<div class="related"><h3>More Like This</h3><div class="row" id="relatedRow"></div></div>`;
    main.innerHTML = html;

    // Movie Play button — popup-free + smooth fade
    document.getElementById("playBtn").onclick = ()=>{
      if(!d.video){ alert("No video available"); return; }
      document.body.style.opacity = "0.6";
      document.body.style.pointerEvents = "none";

      setTimeout(()=>{
        const unique = Date.now();  
        const videoUrl = `${d.video}?session=${unique}`;
        const playerUrl = `player.html?src=${encodeURIComponent(videoUrl)}&title=${encodeURIComponent(d.title||'')}&poster=${encodeURIComponent(d.poster||'')}&prev=${encodeURIComponent(location.pathname+location.search)}`;
        window.location = playerUrl;
      }, 200);
    };

    // Download button
    document.getElementById("downloadBtn").onclick = ()=>{
      if(!d.video){ alert("No video URL available"); return; }
      window.open(d.video, "_blank");
    };

    // Episode play buttons
    document.querySelectorAll(".epPlay").forEach(b=>{
      b.onclick = (ev)=>{
        let v = decodeURIComponent(ev.currentTarget.dataset.video||'');
        if(v) v += `?session=${Date.now()}`;
        const titleEp = (d.title||'') + ' - ' + (ev.currentTarget.closest(".ep").querySelector("div").innerText || 'Episode');
        const playerUrl = `player.html?src=${encodeURIComponent(v)}&title=${encodeURIComponent(titleEp)}&poster=${encodeURIComponent(d.poster||'')}&prev=${encodeURIComponent(location.pathname+location.search)}`;
        window.location = playerUrl;
      };
    });

    // Related section
    onValue(ref(db, "movies"), s2=>{
      const rel = document.getElementById("relatedRow");
      rel.innerHTML = "";
      s2.forEach(x=>{
        const val = x.val();
        if(val && val.category && d.category && val.category === d.category && x.key !== id){
          const card = document.createElement("div");
          card.className = "card";
          const img = document.createElement("img");
          img.src = val.poster;
          img.onclick = ()=> window.location = `details.html?type=movie&id=${x.key}`;
          card.appendChild(img);
          rel.appendChild(card);
        }
      });
    });
  });
}
</script></body>
</html>